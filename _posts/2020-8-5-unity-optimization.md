---

category: Unity
path: '/unity/optimization'
title: '请看着里（把手机横过来）'

layout: nil
---

* 【道歉】
给你带来了不好的回忆，一个大龄男青年，在有女朋友的情况下，还说喜欢你，简直不是人，铁铁的渣男，恶心到了你，给你带了来阴影，后果极其严重，性质极其恶劣。我没有什么可以狡辩的，我确实是在有女朋友的情况下还说了喜欢你。我犯了没有办法被原谅的错误，没有资格让你能原谅我。只想正式的跟你道歉，对不起，对不起，对不起（180度鞠躬）。

【坦白从宽】
我跟我前女朋友是17年认识的，她不是很漂亮，却很热情，不是很聪明，却很善良。
我对她的感觉谈不上心动，却也不讨厌，但是觉得她人挺好的，也能玩到一块去，我们在一起了。那时我相信日久生情，相信感觉都是培养出来的。这种情况持续到18年，我发现我错了，都说水瓶座是捂不热的石头，这句话形容我太正确不过了。我依然不喜欢她，她对我特别好，恨不得把心掏出来给我吃。可悲的是这种好带给我的不是幸福而是愧疚，她对我这么好我也要对她这么好，但是我不爱她我做不到对她这么好，她每对我好一次，我心里就欠下她一份债。我过生日时，他给我精心准备了礼物，我强颜欢笑，心里却高兴不起来，她过生日的时候我能不能给她这么花心思的准备礼物呢？恐怕我根本做不到。他对我好一分，我的负担便多一分。日结月累，这种负担变成了压力，内疚，痛苦，越来越痛苦。我也努力对她好，用来报答他对我的好，仿佛这样我的痛苦可以减轻一些。

18下半年，我逐渐产生了分手的想法，我纠结了很久，道德和良心告诉我：我得对她负责，不能就这么抛弃她。内心却告诉我：你不喜欢她，你不能一直索取她对你的好，跟她在一起你根本就不快乐，这样下去你早晚有一天会撑不下去。到时候再分手对她伤害更大。在这种思想斗争中渡过了半年，我在18年年底的时候跟她提了我内心的想法。
我对她说：“我很痛苦，我尝试通过时间去喜欢上你，可是我真的做不到”我正式跟她提了分手，她很难过，却不愿意放弃，她认为她可以改变我的想法。即使在我表明了这件事我考虑的很清楚了，再坚持下去只是浪费她的青春，我甚至对她说了，现在分手总比以后离婚要好，她还是想坚持下去。

19年上半年，我带她去找过房子，我想的是分手后不能再住一起了。我答应给她支付房租，希望她能搬出去住，看房过程中她心不在焉，眼睛像是要哭了一样，问她房子咋样她也是支支吾吾的，加上看的那几个房子也不好。我心软了，从那之后我再也没有带她找过房子。但我跟她表明了我的立场：你可以自己找房子，啥时候找到了啥时候搬走，我给你付房租，没有钱可以问我要。我不忍心赶她走。她没有找房子，还是住在我家里，她还是对我很好。我知道她并没有死心。我们的关系开始一落千丈了，在一起也不怎么说话，我有意地冷落她，我想让她死心，真的不要在我身上浪费时间了。

【最后一面】
19年7月，你从武汉回来就突然离职了，听说你要回去上学了，之前知道你早晚要走，但没想到这么突然。有时候往你座位瞟上一眼，空空的，只有你留下来的挂在座位上的小兔子，感觉心里空落落的。开周会的时候往你常坐的地方看去，换了个人，也听不到你声音了。我感觉那几天自己像丢了魂似的，做什么事都没有心思。那时我深刻意识到我喜欢上你了，应该是更早就喜欢上了，只是突然的离别让我本来有意压制在内心的喜欢爆发了出来。我非常想联系你，问问你在哪，有没有回学校，还有没有机会见最后一面。可一想到我还是有女朋友的人，我退缩了，还是不打扰你了，让你回去好好上学吧，以后也都见不到了。就这样过了几天，我还是在思念中屈服了，我意识到如果现在不联系你，作为一个普通同事，我将找不到合理的理由再去联系你，也不可能和你见面了。我把还有女朋友得事抛在了脑后，我想我已经跟她提了分手，该说的也说了，不久之后她将离开我。我决定跟你联系，这样还有机会见上一面。
 我鼓起勇气联系了你:“你想学做游戏吗？我教你Unity”。我确实是想教你Unity，我想起你说过你因为想学做游戏而误打误撞学了前端，我想你去上学的话会有很多时间，我带你入个门，感兴趣的话你回学校之后可以自学。所以在跟你吃饭之前，我把我当时上学的时候学习Unity的材料都找出来了。在家备课准备见面跟你怎么讲能够激发你的兴趣，吃饭那天，我早就到了，但是我在楼下整理下载资料，到你快来了，才发现火锅店根本就没开。我自认为能帮你实现做游戏的理想应该是送你离开最好的礼物了吧。

【自欺欺人】
没想到见面之后你跟我说你不需要马上回学校上学，只是找个离职的借口，你还可以再南京待上一段时间，原本以为是最后一面的我听到这个消息心里开心极了，这意味着我以后还有机会能和你见面，你带我去了大渝火锅，有点遗憾，第一次跟你出来吃饭，却是被你带领的，不过依然很开心，很久很久没有这么开心。从那之后我们开始聊天，我记得你问过我有没有女朋友的问题，我的回答是：之前有，分手了。是的，我欺骗了你。真相是我提分手了，但是并没有彻底分开，她还住在我家里，我自己一厢情愿的认为我提了分手那就是分手了，事实是我们没有断绝关系。我欺骗你，我自欺欺人，我不敢告诉你真相。
她发现了我再跟你聊天，我从来不避着她跟你聊天，一是我认为我跟她已经分手，我只是在等她自己搬走，我没有理由藏着掖着。二是我想让她彻底死心。后来我才知道，我认为的这两点在她那里完全不成立。她认为我们没有分手，她不愿意放弃跟我的感情，她相信时间久了我会改变想法，而且认为我之所以跟她分手，全都是因为你。我告诉她，问题出在我和她之间，即使没有你，我和她也一定会分手。她伤心欲绝对我说：“我搬出去可以，但是你永远也不能联系许卓林”。我拒绝了，我没法答应她这个要求。

【纸包不住火】
2020年初，她妈妈微信找我说：“你们分手，家里都劝她过完年不要回南京了，阿姨只求你一件事，劝她别留南京了，回来吧”。我之前跟她沟通过，我劝她回老家，跟我分手之后一个人在南京伤心又孤单，不如回去陪陪父母。她却说，她坚决不回去，她就要留在南京。我回复她母亲说：“我跟她说过，她不愿意回去，我再劝劝她吧”。她母亲说：“唉。今天劝她不回南京说着说着她哭了，我也哭了。” 听到这我心情非常的难受，分手这件事给她和她家里都带来了很大的伤害。我说：“先让她来南京上班吧，先住在我家里”。我这么说是因为我不知道怎么办，跟她分手我感觉已经很愧疚了，给她造成伤害，给她家里人带来伤害。我不知道怎么弥补,本来就欠她的，实在狠不下心来赶她走，拖一天是一天，过一天是一天。
她来南京之后，我跟她说我们互不打扰吧，你可以找对象，你可以随时搬走，我希望你尽快找到合适的目标忘记我，然后分开各自生活。我们白天不说话，晚上也不说话，她开始晚上跟别人打游戏，有男生有女生，看起来挺开心的，我从不过问，我以为一切都挺好的。后来我开始跟你打游戏，我在这屋她在那屋，我们互不打扰，但她有时候会过来，他看到了我跟你打游戏，她也没说什么转身就走了。直到有一天她告诉了你我有女朋友，我一脸蒙蔽，不是说好互不打扰吗？你跟谁打游戏我从来没过问过，你为什要过问我呢？她说：“因为跟我打游戏的人我又不喜欢他，只是朋友，而你喜欢人家，我原本以为我能忍，后来发现我忍不了。”我终于知道，原来她还是没放下，他早就加了你王者荣耀的好友，早就知道我喜欢你，却到现在才告诉你，是因为他知道他一旦跟你说了这件事，我跟她一定会彻底决裂了。 从那之后你就把我删了，我没脸找你，没法解释，我决定，当务之急是跟她彻底的断绝关系，否则决不找你。
【好聚好散】
我对她说，我给你一个月的时间，你搬走吧，你找房子，我给你付一年的房租，她答应了。她在网上买了搬家的纸盒，收了了一些杂物，好像在网上找了房子，但是没有去看房子。
一个月过去了，她没有动静了。我意识到，她自己是不会走的，算了她不走我走吧。
我花了两个礼拜抽时间看了很多房子，最终挑了一个环境交通都很好的房子，付了一年房租，签了合同。又过了一个礼拜，我收拾好东西，一大早就搬走了。她发现后问我去哪了，我告诉他我搬出去住一段时间，让她继续在我家住着。她说，算了，我搬走吧。这次我没有心软，我同意了，我帮她搬家搬了一天，后续有给钱帮她把缺的物品全部买齐，我们终于分开各自生活好聚好散了。我抛弃了她，我心存愧疚，但我任然觉得我的决定是对的，现在分手比以后离婚好一百倍。我只后悔没有早点下决心果断的分手，白白耽误了一年多时间。她最后跟我说了一句话：“早知道结果是这样，我就不坚持了”

【人生若只如初见，何事秋风悲画扇】
说了这么多，是想对你坦白，想向你道歉，希望你能好受一些。我欺骗过你，我承认。但不是因为我想欺骗你感情，而是我不敢告诉你真相。我希望你能原谅我。









**优化时需要注意三个方面：**  
（1）CPU方面.  
（2）GPU方面.  
（3）内存方面.  


## CPU方面的优化
DarwCall影像的是CPU的效率，而且也是在从业者中知名度最高的优化点。但是除了DrawCall之外，还有哪些因素也会影像到CPU效率呢？让我们一一列出比较常见的项目。  
(1)DrawCalls  
(2)物理组建(Physics)  
(3)GC(用来处理内存的，但是是谁使用GC去处理内存呢？)  
(4)脚本中的代码质量

### 对DrawCall 的优化
DrawCall是CPU调用底层图形接口。比如有上千个物体，每一个渲染都需要调用一次底层接口，而每一次调用CPU都需要做很多工作，那么CPU必然不堪重负。但是对于GPU来说，图形处理的工作量是一样的。所以对DrawCall的优化，主要是就是为了尽量解放CPU在调用图形接口上的开销。所以针对DrawCall主要的思路就是每个物体尽量减少渲染次数。多个物体最好一起渲染。所以，按照这个思路就有了三个方案。  
(1)使用DrawCall Batching,也就是描绘调用批处理。Unity3D在运行时会将一些物体进行合并，从而用一个描绘调用来渲染他们  
(2)通过把这些纹理打包成图集尽量减少材质的使用  
(3)尽量减少使用反光，阴影之类的效果，因为那样会使物体多次渲染。  

#### 使用DrawCall Batching批处理
首先要理解为什么两个没有相同材质的物体，及时使用批处理，也无法实现DrawCall的数量的下降和性能的提升。  
因为被“批处理”的两个物体的网格模型需要使用相同材质的目的，在于其纹理是相同的，这样才可以实现同时渲染的目的。因此保证材质相同，是为了保证被渲染的纹理相同。
因此，为了将两个纹理不通的材质合二为一，就需要将纹理打包成图集，具体到合二为一这种情况，就是将两个纹理合成一个纹理，这样就可以只用一个材质来代替之前的两个材质了。  
而DrawCall Batching 本身，也还会细分为两种，即static Batching 静态批处理和Dynamic Batching 动态批处理。

#### Static Batching 静态批处理  
静态那即是不动的？听上去状态也不会改变，没有“伤害恒明”，比如山，石，楼房，校舍等。那和什么比较类似呢？各位一定觉得和场景的属性很像吧，所以场景似乎就可以采用这种方式来减少DrawCall。  
 那么对静态批处理下个定义：只要这些物体不移动，并且拥有相同的材质，静态批处理就允许引擎对任意大小的几何物体进行批处理操作来降低描绘调用。  
那要如何使用静态批处理来较少DrawCall呢？只需要明确指出哪些物体是静止的，并且在游戏中永远不会移动，旋转和缩放。想完成这一步，只需要在检测面板（inspector）中勾选“static”复选框。
 
#### Dynamic Batching 动态批处理
 首先要明确一点，Unity3D的DrawCall动态批处理机制是引擎自动进行的，无需像静态批处理那样手动设置Static。与一个实例化Prefab的例子。如果动态物体共享相同的材质，则引擎会自动对DrawCall优化，也就是使用批处理。首先将一个Cube做成Prefab，然后再实例化500次，看看DrawCall数量，代码如下：


   ```for(int i = 0; i< 500; i++)
  {
      GameObject cube;
      cube = GameObject.Instantiate(prefab) as GameObject;
  }
  //DrawCall 为1 ```

 可以看到DrawCall的数量为1，Batching的数量是499.而在这个过程中，除了实例化创建物体职位什么都没做，不错Unity3D引擎自动处理了这种情况。  
  但是有很多开发者也遇到这种情况，就是也是从prefab实例化创建的物体，为什么DrawCall依然很高呢？这就是上文说的DrawCall的动态批处理存在着很多约束。下面来演示一下。针对cube这样简单的物体的创建，如果校友不慎就会造成DrawCall飞涨的情况。  
   同样创建500个物体，每个物体大小都不相同，也就是transform中的scale属性不通，代码如下：  
   ```for(int i = 0; i< 500; i++)
    {
      GameObject cube;
      cube = GameObject.Instantiate(prefab) as GameObject;
      if(i/100 == 0){
          cube.transform.localScale = new Vector3(2+i,2+i,2+i);
      }
    }
    //DrawCall 101```

可以看到DrawCall的数量上升到了101次，Batching的数量也下降到了399.仅仅是一个简单的cude的创建，如果transform的属性不通，Unity3D竟然也不会去做批处理优化。这仅仅是动态批处理机制的一种约束。总结一下动态批处理的约束，也许能从中找到为什么动态批处理在自己项目中不起作用的原因。  
(1)批处理动态物体需要在每个顶点上进行一定的开销，所以动态批处理仅支持小于900顶点的网格物体。  
(2)如果着色器使用顶点位置，法线和UV值3种属性，那么只能批处理300顶点一下的物体；如果着色器需要使用顶点位置，法线，UV0,UV1和切向量，那么只能批处理180顶点一下的物体。  
(3)不要使用缩放。分别拥有缩放大小（1,1,1）和(2,2,2)的两个物体将不会进行批处理。  
(4)统一缩放的物体不会与非统一缩放的物体进行批处理。  
(5)使用缩放尺度(1,1,1)和(1,2,1)的两个物体将不会进行批处理，但是使用缩放尺度(1,2,1)和(1,3,1)的两个物体将可以进行批处理。    
(6)使用不同材质的实例化物体，将会导致批处理失败。  
(7)拥有lightmap的物体含有额外的（隐藏的）材质属性，例如lightmap的偏移和缩放系数等。所以，拥有lightmap的物体将不会进行批处理（除非它们指向lightmap的同意部分）。  
(8)多通道的shader会妨碍批处理操作。比如几乎Unity3D中所有的着色器在前项渲染中都支持多个光源，并为他们有效的开辟多个通道。  
(9)预设体的实例会自动地使用相同的网格模型和材质。
  
* 所以这里建议开发者尽量使用静态的批处理



    
